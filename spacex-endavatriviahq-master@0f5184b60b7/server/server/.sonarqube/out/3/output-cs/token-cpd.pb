è
SC:\Projects\HQTrivia\server\HQTrivia.KafkaConsumer\Handlers\KafkaConsumerHandler.cs
	namespace 	
HQTrivia
 
. 
KafkaConsumer  
.  !
Handlers! )
{ 
public		 

class		  
KafkaConsumerHandler		 %
:		& '
IHostedService		( 6
{

 
private 
readonly 
string 
topic  %
=& '
$str( 7
;7 8
private 
readonly 
IUserService %
_userService& 2
;2 3
public  
KafkaConsumerHandler #
(# $
IUserService$ 0
userService1 <
)< =
{ 	
_userService 
= 
userService &
;& '
} 	
public 
Task 

StartAsync 
( 
CancellationToken 0
cancellationToken1 B
)B C
{ 	
var 
conf 
= 
new 
ConsumerConfig )
{ 
GroupId 
= 
$str 3
,3 4
BootstrapServers  
=! "
$str# 3
,3 4
AutoOffsetReset 
=  !
AutoOffsetReset" 1
.1 2
Earliest2 :
} 
; 
using 
( 
var 
builder 
=  
new! $
ConsumerBuilder% 4
<4 5
string5 ;
,; <
string 
> 
( 
conf 
) 
. 
Build #
(# $
)$ %
)% &
{ 
builder 
. 
	Subscribe !
(! "
topic" '
)' (
;( )
var 
cancelToken 
=  !
new" %#
CancellationTokenSource& =
(= >
)> ?
;? @
try 
{   
while!! 
(!! 
true!! 
)!!  
{"" 
var## 
consumer## $
=##% &
builder##' .
.##. /
Consume##/ 6
(##6 7
cancelToken##7 B
.##B C
Token##C H
)##H I
;##I J
_userService$$ $
.$$$ %
HandleAnswer$$% 1
($$1 2
consumer$$2 :
.$$: ;
Message$$; B
.$$B C
Key$$C F
,$$F G
consumer$$H P
.$$P Q
Message$$Q X
.$$X Y
Value$$Y ^
)$$^ _
;$$_ `
}%% 
}&& 
catch'' 
('' 
	Exception''  
)''  !
{(( 
builder)) 
.)) 
Close)) !
())! "
)))" #
;))# $
}** 
}++ 
return,, 
Task,, 
.,, 
CompletedTask,, %
;,,% &
}-- 	
public// 
Task// 
	StopAsync// 
(// 
CancellationToken// /
cancellationToken//0 A
)//A B
{00 	
return11 
Task11 
.11 
CompletedTask11 %
;11% &
}22 	
}33 
}44 ÷
=C:\Projects\HQTrivia\server\HQTrivia.KafkaConsumer\Program.cs
var 
builder 
= 
WebApplication 
. 
CreateBuilder *
(* +
args+ /
)/ 0
;0 1
builder		 
.		 
Services		 
.		 
AddDbContext		 
<		  
ApplicationDbContext		 2
>		2 3
(		3 4
options		4 ;
=>		< >
options		? F
.		F G
UseSqlServer		G S
(		S T
builder

 
.

 
Configuration

 
.

 
GetConnectionString

 1
(

1 2
$str

2 E
)

E F
) 
) 
; 
builder 
. 
Services 
. 
AddControllers 
(  
)  !
;! "
builder 
. 
Services 
. #
AddEndpointsApiExplorer (
(( )
)) *
;* +
builder 
. 
Services 
. 
AddSwaggerGen 
( 
)  
;  !
builder 
. 
Services 
. 
AddSingleton 
< 
IUserService *
,* +
UserService, 7
>7 8
(8 9
)9 :
;: ;
builder 
. 
Services 
. 
AddSingleton 
< 
IHostedService ,
,, - 
KafkaConsumerHandler. B
>B C
(C D
)D E
;E F
var 
app 
= 	
builder
 
. 
Build 
( 
) 
; 
if 
( 
app 
. 
Environment 
. 
IsDevelopment !
(! "
)" #
)# $
{ 
app 
. 

UseSwagger 
( 
) 
; 
app 
. 
UseSwaggerUI 
( 
) 
; 
} 
app 
. 
UseAuthorization 
( 
) 
; 
app   
.   
MapControllers   
(   
)   
;   
app"" 
."" 
Run"" 
("" 
)"" 	
;""	 
